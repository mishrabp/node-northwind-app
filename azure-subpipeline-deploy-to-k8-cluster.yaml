# deploy-appservice-template.yml
# It deploys code into app services on Azure

parameters:
- name: environment # don't pass run-time variables
- name: webAppName
- name: subscription
- name: artifactName
  default: drop



jobs:
- deployment: DeployAppService
  environment: ${{ parameters.environment }}
  strategy: 
    runOnce:
      deploy:
        steps:
      #    - task: Docker@2
      #      displayName: 'Build Docker Image'
      #      inputs:
      #        command: 'build'
      #        Dockerfile: '**/Dockerfile'
      #        tags: 'latest'
      #    - task: Docker@2
      #      displayName: 'Login to Docker Hub (Public)'
      #      inputs:
      #        command: login
      #        containerRegistry: 'docker-hub-registry-public'
      #    - task: Docker@2
      #      displayName: 'Push Docker Image to Docker Hub (Public)'
      #      inputs:
      #        containerRegistry: 'docker-hub-registry-public'
      #        repository: 'bibhupmishra/node-northwind-app'
      #        command: 'push'

          - task: KubectlInstaller@0
            inputs:
              kubectlVersion: 'latest'

          - task: Kubernetes@1
            inputs:
              connectionType: 'Azure Resource Manager'
              azureSubscriptionEndpoint: 'Visual Studio Subscription - 113136'
              azureResourceGroup: 'bpm-cowbird-rg'
              kubernetesCluster: 'bpm-cowbird-aks'
              useClusterAdmin: true
              namespace: 'default'
              command: 'apply'
              useConfigurationFile: true
              configuration: '$(System.DefaultWorkingDirectory)/drop/www/k8-deployment-azure-113136.yaml'
              secretType: 'dockerRegistry'
              containerRegistryType: 'Azure Container Registry'
              azureSubscriptionEndpointForSecrets: 'Visual Studio Subscription - 113136'
              azureContainerRegistry: 'bpm2021acr.azurecr.io'
              secretName: 'acr-secret-bibhu'

