# deploy-appservice-template.yml
# It deploys code into app services on Azure

parameters:
- name: environment # don't pass run-time variables
- name: webAppName
- name: subscription
- name: artifactName
  default: drop

variables:
- name: k8sNamespace
  value: 'default'
- name: dockerRegistryServiceConnection
  value: 'docker-azure-registry-private'
- name: containerRegistry
  value: 'bpm2021acr.azurecr.io'
- name: imageRepository
  value: 'node-northwind-app'
- name: tag
  value: 'latest'
- name: imagePullSecret
  value: ''

jobs:
- deployment: DeployAppService
  environment: ${{ parameters.environment }}
  strategy: 
    runOnce:
      deploy:
        steps:
      #    - task: Docker@2
      #      displayName: 'Build Docker Image'
      #      inputs:
      #        command: 'build'
      #        Dockerfile: '**/Dockerfile'
      #        tags: 'latest'
      #    - task: Docker@2
      #      displayName: 'Login to Docker Hub (Public)'
      #      inputs:
      #        command: login
      #        containerRegistry: 'docker-hub-registry-public'
      #    - task: Docker@2
      #      displayName: 'Push Docker Image to Docker Hub (Public)'
      #      inputs:
      #        containerRegistry: 'docker-hub-registry-public'
      #        repository: 'bibhupmishra/node-northwind-app'
      #        command: 'push'

          - task: KubernetesManifest@0
            displayName: Create imagePullSecret
            inputs:
              action: createSecret
              secretName: $(imagePullSecret)
              namespace: $(k8sNamespace)
              dockerRegistryEndpoint: $(dockerRegistryServiceConnection)

          - task: KubernetesManifest@0
            displayName: Deploy to Kubernetes cluster
            inputs:
              action: deploy
              namespace: $(k8sNamespace)
              manifests: |
                $(System.DefaultWorkingDirectory)/drop/www/k8-deployment-azure-113136.yaml
              imagePullSecrets: |
                $(imagePullSecret)
              containers: |
                $(containerRegistry)/$(imageRepository):$(tag)

